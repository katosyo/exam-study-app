# Core Rules（製品版）

## 前提

- ユーザーはプログラミングができるが、**時短のためにAIに実装を依頼**している
- アルゴリズム・ライブラリ調査はAIのほうが速い
- **現在のコンテキスト理解は苦手**なので、不明瞭な点は必ず確認する
- **第三者利用を前提**とし、品質・信頼性・セキュリティを重視する

---

## 製品版開発の基本方針

### 品質優先

- 実装スピードよりも**品質・保守性・セキュリティ**を優先
- テストを書いてから実装する（TDD を推奨）
- コードレビューの視点で実装を行う
- 技術的負債を作らない

### データ保護

- ユーザーデータは**資産**として扱う
- データ損失・漏洩が発生しない設計
- バックアップ・リカバリ戦略を明確にする

### 可用性・信頼性

- サービスの継続性を最優先
- 障害時の影響範囲を最小化
- 適切なエラーハンドリング・リトライ
- ユーザーに技術的詳細を露出しない

---

## セッション運用ルール

### タスク分割

- 1セッションで扱うタスクは**1機能単位**まで
- 大きなタスクは必ず**設計フェーズと実装フェーズを分ける**
- 設計時は以下を明確にする：
  - データ構造（DynamoDB のキー設計など）
  - API 仕様（エンドポイント・リクエスト・レスポンス）
  - エラーケースの洗い出し
  - セキュリティ考慮事項

### 失敗時の対応

2回以上連続でテスト・ビルド・lintに失敗したら：

1. 現状を整理
2. 原因候補を列挙
3. テストケースを追加
4. ユーザーと方針を相談

---

## 作業開始時の必須行動

### 1. リポジトリ状態の確認

```bash
git status
git diff
```

- 無関係な変更がある場合は別タスクとして分離
- コミット粒度を適切に保つ

### 2. 影響範囲の確認

- 変更が他の機能に影響しないか確認
- 破壊的変更の場合は明示的に宣言
- マイグレーション計画を立てる

### 3. テストの確認

- 既存テストが通ることを確認
- 変更箇所に対応するテストを追加

---

## 実装方針（共通）

### 型ファースト

- **型を先に考える**（仕様を明確にする）
- 実装前に型定義・インターフェースを確定
- 型で仕様・制約を表現

### 純粋性・副作用の分離

- 可能な限り**純粋関数**
- 副作用（DB・API・IO）は境界に寄せる
- テスト可能な設計を意識

### 明示的なエラー表現

- Result 型パターンを継続使用
- エラーは型で表現（union type / enum）
- `throw` は境界でのみ使用

### クラス vs 関数

- クラスは「状態が必要な場合」または「明確なライフサイクルがある場合」のみ
- それ以外は関数で実装

---

## テスト戦略

### テストの必須化

製品版では以下のテストを**必須**とする：

1. **Unit Test**
   - domain / service の全ロジック
   - 純粋関数は100%カバレッジを目指す

2. **Integration Test**
   - API エンドポイントの正常系・異常系
   - DynamoDB とのやり取り

3. **E2E Test**（重要な画面のみ）
   - ユーザー登録・ログイン
   - 問題取得・回答・結果表示

### テスト実装の順序

1. **失敗するテストを先に書く**
2. テストが通る最小限の実装
3. リファクタリング
4. エッジケースの追加

---

## ドキュメントと記録

### 必須ドキュメント

- **API 仕様書**（OpenAPI / Swagger 推奨）
- **データベース設計書**（ERD・キー設計）
- **認証フロー図**
- **デプロイ手順書**

### コード内ドキュメント

- 複雑なロジックには必ずコメント
- 「なぜ」を記録（「何を」はコードが語る）
- 設計判断の理由を残す

### セッション記録

- 重要な設計判断は `docs/` に記録
- ADR（Architecture Decision Records）の活用を推奨

---

## 品質チェックリスト

実装完了時に以下を確認：

- [ ] テストが追加され、すべて通る
- [ ] Linter エラーがない
- [ ] TypeScript の型エラーがない
- [ ] セキュリティ考慮事項が満たされている
- [ ] エラーハンドリングが適切
- [ ] ログが適切に出力されている
- [ ] ドキュメントが更新されている
- [ ] 破壊的変更の場合、マイグレーション計画がある

---

## 禁止事項

- テストなしの実装
- `any` の使用（やむを得ない場合は明示的な理由が必要）
- ハードコードされた認証情報・機密情報
- ユーザーに技術的詳細を露出するエラーメッセージ
- 安易な `console.log`（構造化ログを使用）
- データ損失のリスクがある実装

---

## 逸脱禁止

本 Rules に反する実装を行ってはならない。
例外が必要な場合は、**理由・影響・代替案・レビュー結果**を明示すること。
